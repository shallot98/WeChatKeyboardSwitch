name: Build rootless tweak

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    name: ${{ matrix.configuration }} build
    runs-on: macos-13
    strategy:
      fail-fast: false
      matrix:
        configuration: [Release]
    env:
      THEOS: $HOME/theos
      THEOS_PACKAGE_SCHEME: rootless
      FINALPACKAGE: 1

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Cache Theos environment
        id: cache-theos
        uses: actions/cache@v3
        with:
          path: ${{ env.THEOS }}
          key: theos-${{ runner.os }}-${{ matrix.configuration }}-${{ hashFiles('Makefile', 'control', 'layout/**', 'Tweak.xm', 'WeChatKeyboardSwitchPrefs/**/*') }}
          restore-keys: |
            theos-${{ runner.os }}-${{ matrix.configuration }}-
            theos-${{ runner.os }}-

      - name: Install build dependencies
        run: |
          brew install ldid make dpkg fakeroot gnu-sed

      - name: Set up Theos toolchain and SDK
        if: steps.cache-theos.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          git clone --recursive https://github.com/theos/theos.git "$THEOS"
          curl -L --fail https://github.com/theos/ios-toolchain-clang/releases/latest/download/ios-toolchain.tar.xz -o /tmp/ios-toolchain.tar.xz
          tar -xJf /tmp/ios-toolchain.tar.xz -C /tmp
          TOOLCHAIN_SRC=$(find /tmp -maxdepth 1 -type d -name "ios-toolchain*" | head -n 1)
          if [ -z "$TOOLCHAIN_SRC" ]; then
            echo "Unable to locate extracted toolchain directory" >&2
            exit 1
          fi
          mkdir -p "$THEOS/toolchains"
          rm -rf "$THEOS/toolchains/ios"
          mv "$TOOLCHAIN_SRC" "$THEOS/toolchains/ios"
          curl -L --fail https://github.com/theos/sdks/releases/download/16.5/iphoneos16.5.sdk.tar.xz -o /tmp/iphoneos16.5.sdk.tar.xz
          mkdir -p "$THEOS/sdks"
          tar -xJf /tmp/iphoneos16.5.sdk.tar.xz -C "$THEOS/sdks"
          rm -f /tmp/ios-toolchain.tar.xz /tmp/iphoneos16.5.sdk.tar.xz

      - name: Configure toolchain path
        run: echo "$THEOS/toolchains/ios/bin" >> $GITHUB_PATH

      - name: Show build configuration
        run: |
          echo "Configuration: ${{ matrix.configuration }}"
          TARGET=$(awk -F ':=' '/^TARGET/ {gsub(/[[:space:]]+/, "", $2); print $2}' Makefile)
          echo "TARGET=${TARGET:-unknown}"
          echo "THEOS_PACKAGE_SCHEME=$THEOS_PACKAGE_SCHEME"

      - name: Build package
        run: |
          set -euo pipefail
          make clean
          make package

      - name: Capture package metadata
        id: package-meta
        run: |
          set -euo pipefail
          VERSION=$(awk '/^Version:/ {print $2}' control)
          PACKAGE=$(awk '/^Package:/ {print $2}' control)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "package=$PACKAGE" >> $GITHUB_OUTPUT
          ls -1 packages

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package-meta.outputs.package }}-${{ steps.package-meta.outputs.version }}-${{ matrix.configuration }}
          path: packages/*.deb
          if-no-files-found: error
